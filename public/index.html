<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Vocabulary Quiz</title>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #e0e0e0;
            border: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #4285f4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        form {
            margin-bottom: 20px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #357ae8;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .quiz-container {
            margin-top: 20px;
        }
        .quiz-question {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .quiz-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quiz-option:hover {
            background-color: #f0f0f0;
        }
        .quiz-option.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .quiz-option.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .quiz-option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .word-list {
            border-collapse: collapse;
            width: 100%;
        }
        .word-list th, .word-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .word-list th {
            background-color: #f2f2f2;
        }
        .word-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .quiz-controls {
            margin-top: 15px;
            text-align: center;
        }
        #result {
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- <h2>Upload Excel File</h2>
    <input type="file" id="fileInput">
    <button id="processBtn">Process & Download</button> -->


    <h1>Korean Vocabulary Quiz</h1>
    
    
    <div class="tabs">
        <button class="tab active" data-tab="add-words">Add Words</button>
        <button class="tab" data-tab="quiz">Take Quiz</button>
        <button class="tab" data-tab="word-list">Word List</button>
    </div>
    
    <div id="add-words" class="tab-content container active">
        <h2>Add New Korean-English Word Pair</h2>
        <form id="add-word-form">
            <div>
                <label for="korean">Korean Word:</label>
                <input type="text" id="korean" name="korean" required placeholder="e.g. 이름">
            </div>
            <div>
                <label for="english">English Translation:</label>
                <input type="text" id="english" name="english" required placeholder="e.g. name">
            </div>
            <button type="submit">Add Word</button>
        </form>
        <div id="add-message"></div>
    </div>
    
    <div id="quiz" class="tab-content container">
        <h2>Korean to English Quiz</h2>
        <p>Choose the correct English translation for each Korean word.</p>
        
        <div class="quiz-controls">
            <button id="start-quiz">Start New Quiz</button>
            <select id="question-count">
                <option value="5">5 Questions</option>
                <option value="10">10 Questions</option>
                <option value="15">15 Questions</option>
            </select>
        </div>
        
        <div id="quiz-container" class="quiz-container"></div>
        <div id="result"></div>
    </div>
    
    <div id="word-list" class="tab-content container">
        <h2>Word List</h2>
        <p>All Korean-English word pairs in the database:</p>
        <table class="word-list">
            <thead>
                <tr>
                    <th>Korean</th>
                    <th>English</th>
                </tr>
            </thead>
            <tbody id="words-table-body"></tbody>
        </table>
    </div>

    <script>
        $(document).ready(function() {

            let inputData = [];


$('#fileInput').on('change', function (e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    inputData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    console.log("File loaded! Click 'Process & Download'");
  };

  reader.readAsArrayBuffer(file);
});

$('#processBtn').on('click', function () {
  if (!inputData.length) {
    alert("Please upload a file first.");
    return;
  }

  const output = [];

  inputData.forEach(row => {
    if (!row[0]) return;
    const rawTokens = row[0].split(" ");
            const tokens = [];

            const test = word => /[가-힣]/.test(word);

            // Loop through all tokens
            for (let i = 0; i < rawTokens.length; i++) {
            const current = rawTokens[i];
            const next = rawTokens[i + 1];

            // Skip if current is a number AND next is Korean
            if (!isNaN(current) && next && test(next)) {
                continue; // skip this number
            }

            tokens.push(current);
            }

    // Detect Korean (basic heuristic)
    const isKorean = word => /[가-힣]/.test(word);

    let korean1 = "";
    let english1 = "";
    let korean2 = "";
    let english2 = "";

    // Step 1: Korean 1
    korean1 = tokens.shift();

    // Step 2: English 1 — gather until next Korean
    while (tokens.length && !isKorean(tokens[0])) {
      english1 += (english1 ? " " : "") + tokens.shift();
    }

    // Step 3: Korean 2
    if (tokens.length) {
      korean2 = tokens.shift();
    }

    // Step 4: The rest is English 2
    english2 = tokens.join(" ");
    if(korean1 && english1){
        output.push({"korean":korean1,"english":english1});
    }
    if(korean2 && english2){
        output.push({"korean":korean2,"english":english2});
    }

  });
  $.ajax({
                    url: '/api/words/multi',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(output),
                    success: function(data) {
                        showMessage(`Word added successfully: ${korean} = ${english}`, 'success');
                        $('#add-word-form')[0].reset();
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to add word';
                        showMessage(errorMsg, 'error');
                    }
                });
});


            // Current quiz state
            let currentQuiz = [];
            let currentAnswers = [];
            let currentQuestion = 0;
            
            // Tab switching
            $('.tab').click(function() {
                const tabId = $(this).data('tab');
                
                // Update active tab
                $('.tab').removeClass('active');
                $(this).addClass('active');
                
                // Show corresponding content
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
                
                // Load data when switching to specific tabs
                if (tabId === 'word-list') {
                    loadWordList();
                }
            });
            
            // Add new word
            $('#add-word-form').submit(function(e) {
                e.preventDefault();
                
                const korean = $('#korean').val().trim();
                const english = $('#english').val().trim();
                
                if (!korean || !english) {
                    showMessage('Please enter both Korean and English words', 'error');
                    return;
                }
                
                $.ajax({
                    url: '/api/words',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ korean, english }),
                    success: function(data) {
                        showMessage(`Word added successfully: ${korean} = ${english}`, 'success');
                        $('#add-word-form')[0].reset();
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to add word';
                        showMessage(errorMsg, 'error');
                    }
                });
            });
            
            // Load word list
            function loadWordList() {
                $.ajax({
                    url: '/api/words',
                    type: 'GET',
                    success: function(words) {
                        $('#words-table-body').empty();
                        
                        if (words.length === 0) {
                            $('#words-table-body').append('<tr><td colspan="2">No words in database yet</td></tr>');
                        } else {
                            $.each(words, function(i, word) {
                                $('#words-table-body').append(`
                                    <tr>
                                        <td>${word.korean}</td>
                                        <td>${word.english}</td>
                                    </tr>
                                `);
                            });
                        }
                    },
                    error: function() {
                        console.error('Error loading word list');
                    }
                });
            }
            
            // Start a new quiz
            $('#start-quiz').click(function() {
                const count = parseInt($('#question-count').val());
                
                $.ajax({
                    url: `/api/quiz?count=${count}`,
                    type: 'GET',
                    success: function(questions) {
                        if (questions.length > 0) {
                            currentQuiz = questions;
                            currentAnswers = new Array(questions.length).fill(null);
                            currentQuestion = 0;
                            
                            displayCurrentQuestion();
                            $('#result').text('');
                        } else {
                            $('#quiz-container').html('<p>Not enough words in the database to create a quiz. Please add more words first.</p>');
                        }
                    },
                    error: function() {
                        $('#quiz-container').html('<p>Error connecting to server</p>');
                    }
                });
            });
            
            // Display current question
            function displayCurrentQuestion() {
                if (!currentQuiz.length) return;
                
                const question = currentQuiz[currentQuestion];
                
                let quizHTML = `
                    <div class="quiz-question">
                        <h3>Question ${currentQuestion + 1} of ${currentQuiz.length}</h3>
                        <p>What is the English translation of: <strong>${question.korean}</strong>?</p>
                        <div class="quiz-options">
                `;
                
                // Add options
                $.each(question.options, function(index, option) {
                    quizHTML += `<div class="quiz-option" data-index="${index}">${option}</div>`;
                });
                
                quizHTML += `
                        </div>
                    </div>
                    <div class="quiz-controls">
                        ${currentQuestion > 0 ? '<button id="prev-question">Previous</button>' : ''}
                        <button id="next-question">${currentQuestion < currentQuiz.length - 1 ? 'Next' : 'Finish'}</button>
                    </div>
                `;
                
                $('#quiz-container').html(quizHTML);
                
                // Add event listeners to options
                $('.quiz-option').click(function() {
                    selectOption(parseInt($(this).data('index')));
                });
                
                // Show selected option if already answered
                if (currentAnswers[currentQuestion] !== null) {
                    selectOption(currentAnswers[currentQuestion], false);
                }
                
                // Add event listeners to navigation buttons
                $('#prev-question').click(function() {
                    if (currentQuestion > 0) {
                        currentQuestion--;
                        displayCurrentQuestion();
                    }
                });
                
                $('#next-question').click(function() {
                    if (currentQuestion < currentQuiz.length - 1) {
                        currentQuestion++;
                        displayCurrentQuestion();
                    } else {
                        showQuizResults();
                    }
                });
            }
            
            // Select an option
            function selectOption(index, record = true) {
                // Clear previous selections
                $('.quiz-option').removeClass('selected');
                
                // Add selected class
                $(`.quiz-option[data-index="${index}"]`).addClass('selected');
                
                // Record the answer
                if (record) {
                    currentAnswers[currentQuestion] = index;
                }
            }
            
            // Show quiz results
            function showQuizResults() {
                let score = 0;
                let resultsHTML = '<h3>Quiz Results</h3>';
                
                $.each(currentQuiz, function(index, question) {
                    const isCorrect = currentAnswers[index] === question.correctIndex;
                    if (isCorrect) {
                        score++;
                    }
                    
                    resultsHTML += `
                        <div class="quiz-question">
                            <p>Question ${index + 1}: What is the English translation of <strong>${question.korean}</strong>?</p>
                            <div class="quiz-options">
                    `;
                    
                    $.each(question.options, function(optIndex, option) {
                        let className = '';
                        if (optIndex === question.correctIndex) {
                            className = 'correct';
                        } else if (optIndex === currentAnswers[index] && !isCorrect) {
                            className = 'incorrect';
                        }
                        resultsHTML += `<div class="quiz-option ${className}">${option}</div>`;
                    });
                    
                    resultsHTML += `
                            </div>
                            <p>${isCorrect ? '✓ Correct' : '✗ Incorrect'}</p>
                        </div>
                    `;
                });
                
                $('#quiz-container').html(resultsHTML);
                $('#result').text(`Your score: ${score} out of ${currentQuiz.length} (${Math.round(score / currentQuiz.length * 100)}%)`);
            }
            
            // Show message
            function showMessage(text, type = 'success') {
                $('#add-message').html(`<div class="message ${type}">${text}</div>`);
                
                // Clear message after 5 seconds
                setTimeout(function() {
                    $('#add-message').html('');
                }, 5000);
            }
            
            // Initial load of word list
            loadWordList();
        });
    </script>
</body>
</html>